<?!= include('lib', data) ?>
<script>
  const thread = <?= data.thread ?>;
  let target = null;
  let list = null;

  function sortCategoriesWithUncategorizedLast(a, b) {
    if (a == 'Uncategorized') {
      return 1;
    } else if (b == 'Uncategorized') {
      return -1;
    } else {
      return a.localeCompare(b);
    }
  }

  function showLists(lists) {
    const content = document.getElementById('content');
    replaceContent('');
    for (const category of Object.keys(lists).sort(
      sortCategoriesWithUncategorizedLast
    )) {
      const categoryElement = document.createElement('div');
      categoryElement.classList.add('category');
      categoryElement.innerHTML = `<h3>${category}</h3>`;
      for (const list of lists[category]) {
        const listElement = document.createElement('div');
        listElement.id = list.id;
        listElement.classList.add('list');
        listElement.innerHTML = `<div class="name">${list.name}</div>
        <div class="description">${list.description}</div>`;
        attachEvent(categoryElement.appendChild(listElement), 'click', () => chooseTarget(list));
      }
      content.appendChild(categoryElement);
    }
  }

  function chooseTarget(listResponse) {
    list = listResponse;
    replaceContent('Loading…');
    google.script.run
      .withSuccessHandler(replaceContent)
      .getImportTargetOptions(list);
  }

  function importData(targetSelection) {
    target = targetSelection;
    replaceContent('Loading…');
    updateProgress();
    google.script.run
      .importData(list, target, thread);
  }

  function updateProgress() {
      google.script.run
        .withSuccessHandler((progress) => {
          if (progress.complete) {
              replaceContent(progress.complete);
          } else {
            document.getElementById('content').innerHTML = progress.html;
            updateProgress();
          }
        })
        .getProgress(thread);
    }

  google.script.run.withSuccessHandler(showLists).connectGetLists();
</script>
