<script>
  const thread = '<?= data.thread ?>';
  let target = null;
  let list = null;

  function replaceContent(html) {
    document.getElementById('content').innerHTML = html;
  }

  function attachEvent(element, event, handler) {
    if (element.attachEvent) {
      element.attachEvent(event, handler);
    } else {
      element.addEventListener(event, handler);
    }
  }

  function sortCategoriesWithUncategorizedLast(a, b) {
    if (a == UNCATEGORIZED) {
      return 1;
    } else if (b == UNCATEGORIZED) {
      return -1;
    } else {
      return a.localeCompare(b);
    }
  }

  function showLists(lists) {
    const content = document.getElementById('content');
    replaceContent('');
    for (const category in lists) {
      for (const list of lists[category]) {
        const l = document.createElement('div');
        l.id = list.id;
        l.classList.add('list');
        l.innerHTML = `<div class="name">${list.name}</div>
        <div class="description">${list.description}</div>`;
        attachEvent(content.appendChild(l), 'click', () => chooseTarget(list));
      }
    }
  }

  function chooseTarget(list) {
    replaceContent(`<div>
        <div>Where would you like the data from ${list.name} to be imported?</div>
        <div class="bottom-right">
            <button id="selection" class="button red">Replace Selection</button>
            <button id="sheet" class="button action">Add a sheet</button>
            <button id="spreadsheet" class="button action">Create a new spreadsheet</button>
        </div>
      </div>`);
    attachEvent(document.getElementById('selection'), 'click', () =>
      importData(list, 'selection')
    );
    attachEvent(document.getElementById('sheet'), 'click', () =>
      importData(list, 'sheet')
    );
    attachEvent(document.getElementById('spreadsheet'), 'click', () =>
      importData(list, 'spreadsheet')
    );
  }

  function updateProgress() {
    google.script.run
      .withSuccessHandler((progress) => {
        if (progress.complete) {
          if (target == 'selection') {
            google.script.host.close();
          } else {
            replaceContent(`<div>The ${target} has been created and connected to "${
              list.name
            }".</div>
            <div class="bottom-right"><a id="open" href="${
              progress.complete
            }" target="${
              target == 'sheet' ? '_top' : '_blank'
            }">Open ${target}</a</div>`);
            attachEvent(document.getElementById('open'), 'click', () =>
              google.script.host.close()
            );
          }
        } else {
          document.getElementById('content').innerHTML = progress.html;
          updateProgress();
        }
      })
      .getProgress(thread);
  }

  function importData(l, t) {
    list = l;
    target = t;
    replaceContent('Loadingâ€¦');
    google.script.run
      .withSuccessHandler(updateProgress)
      .importData(list, target, thread);
  }

  google.script.run.withSuccessHandler(showLists).connectGetLists();
</script>
